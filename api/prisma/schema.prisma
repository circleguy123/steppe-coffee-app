generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(uuid())
  phone                String             @unique
  name                 String?
  surName              String?
  birthDate            DateTime?
  role                 String             @default("user")
  password             String?
  loginCode            String?
  loginCodeIssuedAt    DateTime?
  iikoId               String?
  deletedAt            DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  eventRsvps           EventRsvp[]
  paymentCards         EpayUserCard[]
  orders               UserOrder[]
  communities          Community[]
  communityMemberships CommunityMember[]
  tableBookings        TableBooking[]
  loyaltyAccounts      LoyaltyAccount[]
}

model Device {
  id                String     @id @default(uuid())
  userId            String?
  loyaltyAccounts   LoyaltyAccount[]
}

model LoyaltyAccount {
  id                String    @id  @default(uuid())
  userId            String?
  deviceId          String?
  balance           Int
  cardId            String

  user              User? @relation(fields: [userId], references: [id])
  device            Device? @relation(fields: [deviceId], references: [id])
}

model UserOrder {
  id                String    @id @default(uuid())
  total             Int
  userId            String
  user              User @relation(fields: [userId], references: [id])
  iikoStatus        String
  paymentStatus     String

  organizationId    String
  terminalGroupId   String
  menuId            String

  iikoOrderId       String?
  orderNumber       Int @default(autoincrement())

  userOrderItem     UserOrderItem[]

  type              UserOrderType @default(Takeaway)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt  @default(now())
}

enum UserOrderType {
  Takeaway
  Delivery
  Reward
}

model UserOrderItem {
  id                String    @id @default(uuid())
  productId         String
  productName       String?
  amount            Int
  price             Float
  productSizeId     String?
  userOrderId       String
  
  userOrder         UserOrder @relation(fields: [userOrderId], references: [id])
}

model IikoTerminal {
  id                String    @id @default(uuid())
  terminalGroupId   String
  organizationId    String
  name              String
  timeZone          String

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Event {
  id                String    @id @default(uuid())
  title             String
  description       String
  eventDate         DateTime
  eventLength       String
  ticketsNumber     Int
  photoUrl          String?
  price             Int
  location          String?
  eventUrl          String?
  isArchived        Boolean @default(false)

  eventRsvp         EventRsvp[]
}

model EventRsvp {
  id                String    @id @default(uuid())
  userId            String
  eventId           String
  reservedAt        DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id])
  event             Event     @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

model Membership {
  id                String @id @default(uuid())
  userId            String
  activatedAt       DateTime?
  expiresAt         DateTime?
  status            String? @default("idle")
  productId         String?
  total             Float?
  cardId            String?

  createdAt         DateTime @default(now())
  
  @@index([expiresAt, status])
}

enum EpayOrderType {
  Membership
  UserOrder
  SaveCard
}

enum EpayOrderStatus {
  pending
  new
  paid
  failed
  canceled
}

model EpayOrderInvoice {
  id                Int       @id @default(autoincrement())
  userOrderId       String?
  membershipId      String?
  type              EpayOrderType 
  userId            String

  createdAt         DateTime  @default(now())
  paidAt            DateTime?

  userCard          EpayUserCard[]

  status            EpayOrderStatus @default(new)
}

model EpayUserCard {
  id                String   @id @default(uuid())
  cardId            String
  cardMask          String
  cardType          String
  approvalCode      String?
  amount            Float
  currency          String
  dateTime          DateTime
  description       String?
  ip                String?
  ipCity            String?
  ipCountry         String?
  ipDistrict        String?
  ipLatitude        Float?
  ipLongitude       Float?
  ipRegion          String?
  issuer            String?
  language          String?
  name              String?
  phone             String?
  reason            String?
  reasonCode        Int?
  reference         String?
  secure            String?
  secureDetails     String?
  terminal          String?

  allData           Json

  accountId         String
  user              User     @relation(fields: [accountId], references: [id])

  invoiceId         Int
  epayOrderInvoice  EpayOrderInvoice @relation(fields: [invoiceId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  @@unique([accountId, cardId])
}

model EpayOrderError {
  id                String  @id @default(uuid())
  errorData         Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Community {
  id          String            @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  isPublic    Boolean           @default(true)
  createdById String
  createdBy   User              @relation(fields: [createdById], references: [id])
  members     CommunityMember[]
  events      CommunityEvent[]
  tableBookings TableBooking[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model CommunityMember {
  id          String    @id @default(uuid())
  communityId String
  userId      String
  role        String    @default("member")
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id])
  joinedAt    DateTime  @default(now())

  @@unique([communityId, userId])
}

model CommunityEvent {
  id           String         @id @default(uuid())
  communityId  String?
  title        String
  description  String?
  imageUrl     String?
  eventDate    DateTime
  eventLength  String?
  location     String?
  maxAttendees Int?
  price        Int            @default(0)
  community    Community?     @relation(fields: [communityId], references: [id])
  bookings     TableBooking[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model TableBooking {
  id          String          @id @default(uuid())
  userId      String
  eventId     String?
  communityId String?
  tableNumber String?
  date        DateTime
  timeSlot    String?
  partySize   Int             @default(1)
  status      String          @default("confirmed")
  notes       String?
  user        User            @relation(fields: [userId], references: [id])
  event       CommunityEvent? @relation(fields: [eventId], references: [id])
  community   Community?      @relation(fields: [communityId], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Announcement {
  id        String    @id @default(uuid())
  title     String
  message   String
  type      String    @default("info")
  imageUrl  String?
  linkUrl   String?
  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}